"use strict";(self.webpackChunkdocs_contracts=self.webpackChunkdocs_contracts||[]).push([[266],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>p});var i=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)t=r[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=i.createContext({}),d=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=d(e.components);return i.createElement(l.Provider,{value:n},e.children)},u="mdxType",f={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=d(t),h=a,p=u["".concat(l,".").concat(h)]||u[h]||f[h]||r;return t?i.createElement(p,s(s({ref:n},c),{},{components:t})):i.createElement(p,s({ref:n},c))}));function p(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=t.length,s=new Array(r);s[0]=h;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[u]="string"==typeof e?e:a,s[1]=o;for(var d=2;d<r;d++)s[d]=t[d];return i.createElement.apply(null,s)}return i.createElement.apply(null,t)}h.displayName="MDXCreateElement"},5764:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>f,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var i=t(7462),a=(t(7294),t(3905));const r={sidebar_position:3},s="NFT Auction",o={unversionedId:"nft/markdown-features",id:"nft/markdown-features",title:"NFT Auction",description:"Implementing basic TON NFT auction functionality",source:"@site/docs/nft/markdown-features.mdx",sourceDirName:"nft",slug:"/nft/markdown-features",permalink:"/docs.contracts/docs/nft/markdown-features",draft:!1,editUrl:"https://github.com/Ton-Dynasty/tondynasty-contracts/pulls/docs/nft/markdown-features.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"NFT Item",permalink:"/docs.contracts/docs/nft/NFTItem"}},l={},d=[{value:"Architecture",id:"architecture",level:2},{value:"How does the Auction functionality work?",id:"how-does-the-auction-functionality-work",level:2},{value:"NFT sellers can perform the following actions to sell or auction their NFTs:",id:"nft-sellers-can-perform-the-following-actions-to-sell-or-auction-their-nfts",level:2},{value:"Create an auction for a single NFT and customize its auction by specifying the following:",id:"create-an-auction-for-a-single-nft-and-customize-its-auction-by-specifying-the-following",level:3},{value:"Bidders can perform the following actions using the Auction contract:",id:"bidders-can-perform-the-following-actions-using-the-auction-contract",level:2},{value:"Customize the auction for a single NFT by specifying the following:",id:"customize-the-auction-for-a-single-nft-by-specifying-the-following",level:3},{value:"Purchase an NFT by specifying the following during the sale:",id:"purchase-an-nft-by-specifying-the-following-during-the-sale",level:3},{value:"Additional functions available",id:"additional-functions-available",level:2},{value:"Let&#39;s TON it up!!!",id:"lets-ton-it-up",level:2},{value:"With NFTAuctionMarketStandard",id:"with-nftauctionmarketstandard",level:3},{value:"Seller needs to first transfer NFT to Auction Market",id:"seller-needs-to-first-transfer-nft-to-auction-market",level:3},{value:"After the Auction Market successfully establishes a dedicated NFT Auction Contract",id:"after-the-auction-market-successfully-establishes-a-dedicated-nft-auction-contract",level:3},{value:"Settling the NFT Auction",id:"settling-the-nft-auction",level:3},{value:"Additional Functions",id:"additional-functions",level:2},{value:"Revise SetUp Auction",id:"revise-setup-auction",level:3},{value:"EndAuction",id:"endauction",level:3},{value:"NFT Auction Market Contract Internal Functions and Get Methods",id:"nft-auction-market-contract-internal-functions-and-get-methods",level:3},{value:"NFT Auction Contract Internal Functions and Get Methods",id:"nft-auction-contract-internal-functions-and-get-methods",level:3}],c={toc:d},u="wrapper";function f(e){let{components:n,...r}=e;return(0,a.kt)(u,(0,i.Z)({},c,r,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"nft-auction"},"NFT Auction"),(0,a.kt)("p",null,"Implementing basic TON NFT auction functionality"),(0,a.kt)("h2",{id:"architecture"},"Architecture"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Architecture",src:t(5649).Z,width:"3869",height:"3536"}),"\nLeveraging the advantages of TON parent-child contracts, NFT holders create a dedicated ",(0,a.kt)("strong",{parentName:"p"},"NFT Auction Contract")," through the ",(0,a.kt)("strong",{parentName:"p"},"NFT Auction Market Contract")," for auctioning."),(0,a.kt)("h2",{id:"how-does-the-auction-functionality-work"},"How does the Auction functionality work?"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"This smart contract interface can be used for NFT auctions (or just buying/selling) in a decentralized and flexible manner."),(0,a.kt)("li",{parentName:"ul"},"Sellers and bidders are able to create customized auctions and bids, enabling a comprehensive NFT auction/selling mechanism.")),(0,a.kt)("h2",{id:"nft-sellers-can-perform-the-following-actions-to-sell-or-auction-their-nfts"},"NFT sellers can perform the following actions to sell or auction their NFTs:"),(0,a.kt)("h3",{id:"create-an-auction-for-a-single-nft-and-customize-its-auction-by-specifying-the-following"},"Create an auction for a single NFT and customize its auction by specifying the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"NFTAddress"),": The address of the NFT being auctioned."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"reservePrice"),": The auction begins when this price is reached, and users have a specific period of time to make subsequent higher bids. If ",(0,a.kt)("inlineCode",{parentName:"li"},"buyNowPrice")," is also set, the reserve price cannot be higher than the ",(0,a.kt)("inlineCode",{parentName:"li"},"buyNowPrice"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"buyNowPrice"),": The auction automatically ends when a buyer reaches this price."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"auctionEnd"),": The deadline for this NFT auction bidding."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"defaultAuctionBidPeriod"),": Specifies the duration of the auction after reaching the reserve price. Each time a higher bid is reached, the auction will continue for this period again. For example, if the auction bid period is set to x, and the reserve price is reached at time T0, the auction will end at time T0+x. However, if a higher bid is made at time T1 (where T0 < T1 < T0+x) by another bidder, the auction end time will be updated to T1 +x."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"defaultBidIncreasePercentage"),": It determines the amount a bidder must deposit to become the highest bidder. Therefore, if the bid amount is X, the next bidder must bid X + ((X * bid increase percentage)/10000)."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"beneficiary"),": The ",(0,a.kt)("inlineCode",{parentName:"li"},"Address")," specified to receive the auction proceeds when the auction ends.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"message SetUpAuction {\n    nftAddress: Address;            // NFT address to be auctioned\n    reservePrice: Int as coins;     // minimum bid price to start the auction timer\n    buyNowPrice: Int as coins;      // price at which the NFT can be directly bought\n    auctionPeriod: Int as uint256;  // time when the auction ends after it starts\n    beneficiary: Address?;           // the address of the beneficiary\n}\n")),(0,a.kt)("h2",{id:"bidders-can-perform-the-following-actions-using-the-auction-contract"},"Bidders can perform the following actions using the Auction contract:"),(0,a.kt)("h3",{id:"customize-the-auction-for-a-single-nft-by-specifying-the-following"},"Customize the auction for a single NFT by specifying the following:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"bidVale"),": If there is already a bid, bidders must bid a higher amount by the bid increase percentage. But if this is already satisfied, bidders don't need to bid higher than the seller's set reserve price (in this case, the auction will not start). Therefore, if there are no bids on the auction, bidders can specify any amount."),(0,a.kt)("li",{parentName:"ul"},"Users can also make custom bids, specifying an NFT recipient, and if their bid is successful, the NFT will be transferred to that recipient.")),(0,a.kt)("h3",{id:"purchase-an-nft-by-specifying-the-following-during-the-sale"},"Purchase an NFT by specifying the following during the sale:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In this case, buyers can bid an amount less than the buy-now price, which will not end the sale. Then, buyers must bid an amount higher by the default percentage than the previous lower bid. If the bidder specifies an amount equal to or higher than the buy-now price, the sale will end, and the NFT and purchase amount will be transferred.")),(0,a.kt)("h2",{id:"additional-functions-available"},"Additional functions available"),(0,a.kt)("p",null,"Sellers can:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Withdraw their auction if the reserve price has not been met or at any time during the sale."),(0,a.kt)("li",{parentName:"ul"},"Update the auction's reserve price. This action can only be done if there have been no bids exceeding the original reserve price."),(0,a.kt)("li",{parentName:"ul"},"Update the buy-now price for the auction or sale. If there has been a bid on the auction or sale, and this update would mean this bid now meets the buy-now price, the auction or sale will end, and the NFT and bid amount will be allocated accordingly."),(0,a.kt)("li",{parentName:"ul"},"Accept the highest bid amount and end the auction or sale.")),(0,a.kt)("p",null,"Bidders can:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Anyone can settle the auction and distribute the bids and NFT to the respective seller and recipient once the auction bid period has passed (the reserve bid has been met)."),(0,a.kt)("li",{parentName:"ul"},"When a bidder's ",(0,a.kt)("inlineCode",{parentName:"li"},"bidVale")," is surpassed by a new bidder's ",(0,a.kt)("inlineCode",{parentName:"li"},"bidVale"),", the previous bid's ",(0,a.kt)("inlineCode",{parentName:"li"},"bidVale")," is returned to the bidder, and the new highest bid price and bidder are updated."),(0,a.kt)("li",{parentName:"ul"},"The seller of the NFT cannot bid on their own NFT auction.")),(0,a.kt)("h2",{id:"lets-ton-it-up"},"Let's TON it up!!!"),(0,a.kt)("h3",{id:"with-nftauctionmarketstandard"},"With NFTAuctionMarketStandard"),(0,a.kt)("p",null,"Github Repo: ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Ton-Dynasty/tondynasty-contracts"},"https://github.com/Ton-Dynasty/tondynasty-contracts")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"trait NFTAuctionMarketStandard {\n    owner: Address;\n    // Check whether nft is transferred to NFT Auction Market Contract\n    auctionTransferCheck: map<Int, Int>; // key => hash(sellerAddress and nftAddress), value => 1: set, 0: not set\n    // Check whether nft auction is over or not\n    auctionOverCheck: map<Address, Address>;  // key => nft auction contract address, value => 1: not over, 0: over\n\n    // @dev Default parameters for setting up an NFT auction\n    virtual const defaultBidIncreasePercentage: Int = 100;\n    virtual const defaultAuctionBidPeriod: Int = 86400; // 1 day\n    virtual const minimumSettableIncreasePercentage: Int = 100;\n    virtual const maximumMinPricePercentage: Int = 8000;\n}\n")),(0,a.kt)("p",null,"Quickly implement your own Auction Contract by inheriting ",(0,a.kt)("inlineCode",{parentName:"p"},"NFTAuctionMarketStandard"),", with the flexibility to rewrite default basic bidding variables."),(0,a.kt)("h3",{id:"seller-needs-to-first-transfer-nft-to-auction-market"},"Seller needs to first transfer NFT to Auction Market"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// @dev Processes the OwnershipAssigned message and updates auction mappings,\n//      and confirms NFT transfer to the Auction Market.\nreceive(msg: OwnershipAssigned) {\n    let ctx: Context = context();\n    let prev_owner: Address = msg.prev_owner; // Seller Address\n    let nftAddress: Address = ctx.sender;\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(prev_owner, nftAddress);\n    // Set nft transfer checking to 1\n    self.auctionTransferCheck.set(hashSellerNftAddress, 1);\n    let payload: Slice = msg.forward_payload;\n\n    if(payload.empty() == false) {\n        self._parse_forward_payload(prev_owner, nftAddress, payload);\n    }\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The Seller sends a ",(0,a.kt)("inlineCode",{parentName:"li"},"Transfer")," message to the NFT Item. When the NFT Owner changes to the Auction Market, the NFT Item will send an ",(0,a.kt)("inlineCode",{parentName:"li"},"OwnershipAssigned")," message to the Auction Market Contract. Upon receiving the message, the Auction Contract will record the transfer as successful."),(0,a.kt)("li",{parentName:"ul"},"The Seller can use the ",(0,a.kt)("inlineCode",{parentName:"li"},"OwnershipAssigned")," message's ",(0,a.kt)("inlineCode",{parentName:"li"},"custom_payload")," to fill in the basic function of ",(0,a.kt)("inlineCode",{parentName:"li"},"SetUpAuction"),". If ",(0,a.kt)("inlineCode",{parentName:"li"},"custom_payload")," is filled in, it will also Deploy the NFT Auction Contract for the Seller simultaneously."),(0,a.kt)("li",{parentName:"ul"},"If `custom")),(0,a.kt)("p",null,"_payload",(0,a.kt)("inlineCode",{parentName:"p"},"is not filled in, you can send a"),"SetUpAuction` message to the NFT Auction Market contract again and Deploy the NFT Auction Contract."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// @dev Handles the receipt of a SetUpAuction message.\n//      First, it verifies if the NFT has been transferred to the NFT Auction Market Contract.\n//      Upon successful validation, it sets up the auction for the specified NFT and deploys\n//      a new NFT Auction Contract instance for it.\nreceive(msg: SetUpAuction) {\n    let ctx: Context = context();\n    let sellerAddress: Address = ctx.sender;\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(sellerAddress, msg.nftAddress);\n    self._auction_transfer_validate(hashSellerNftAddress);\n    if(msg.beneficiary == null) {\n        msg.beneficiary = sellerAddress;\n    }\n    // Set up auction info\n    let auctionInfo: AuctionInfo = self._set_up_auction(sellerAddress, msg.nftAddress, msg.reservePrice, msg.N, msg.auctionPeriod, msg.beneficiary!!); // set up auction\n    self._set_price_validate(msg.buyNowPrice, msg.reservePrice);\n    let nftAuctionInit: StateInit = self._nft_auction_init(msg.nftAddress, sellerAddress);\n    let nftAuctionAddress: Address = self.get_nft_auction_address(msg.nftAddress, sellerAddress);\n    self._auction_set_validate(nftAuctionAddress);\n    self.auctionOverCheck.set(nftAuctionAddress, msg.nftAddress);\n\n    // Deploy a new NFT Auction Contract\n    self._build_auction(nftAuctionAddress, auctionInfo, nftAuctionInit);\n}\n")),(0,a.kt)("h3",{id:"after-the-auction-market-successfully-establishes-a-dedicated-nft-auction-contract"},"After the Auction Market successfully establishes a dedicated NFT Auction Contract"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Bidders can send a ",(0,a.kt)("inlineCode",{parentName:"li"},"Bid")," message to the NFT Auction Contract, bidding on this NFT, where ",(0,a.kt)("inlineCode",{parentName:"li"},"message.value")," is the bid price."),(0,a.kt)("li",{parentName:"ul"},"Upon receiving the ",(0,a.kt)("inlineCode",{parentName:"li"},"Bid")," message, the Auction Market will first check if this auction is still active or not.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// Check if auction is still active.\nrequire(now() < self.auctionEndTime || self.auctionEndTime == 0, "Auction ended");\nrequire(self.isInitialized == 1, "Contract is not initialized");\nrequire((now() < self.auctionBidPeriod) |(self.auctionBidPeriod == 0), "Auction bid period ended");\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Check if ",(0,a.kt)("inlineCode",{parentName:"li"},"bidValue")," exceeds ",(0,a.kt)("inlineCode",{parentName:"li"},"buyNowPrice"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"let bidValue: Int = ctx.value;\nlet buyNowPrice: Int = self.auctionInfo.buyNowPrice;\nif(bidValue >= buyNowPrice) {\n    self.auctionInfo.nftHighestBid = bidValue;\n    // Pay winning bid amount to seller.\n    self._send_winning_bid_amount();\n    // Transfer NFT to buyer\n    self._transfer_nft(buyer);\n    self.isInitialized = 0;\n    return;\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If it doesn't exceed the direct purchase price, it will check if it exceeds the minimum increase percentage of the current highest bid")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'let bidIncreaseAmount: Int = (self.auctionInfo.nftHighestBid * (10000 + self.auctionInfo.bidIncreasePercentage)) / 10000;\nrequire(bidValue > bidIncreaseAmount, "Bid doesn\'t meet the minimum increase requirement");\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If it exceeds the increase percentage, the Previous Highest Bid Value will be returned to the Previous Highest Bidder.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// Send back previous highest bid to previous highest bidder.\nlet prevNftHighestBidder: Address = self.auctionInfo.nftHighestBidder;\nlet prevNftHighestBid: Int = self.auctionInfo.nftHighestBid;\nlet paybackTon: Int = max(prevNftHighestBid - self.minTonsForStorage - self.gasConsumption,0);\nsend(SendParameters{\n    to: prevNftHighestBidder,\n    value: paybackTon, \n    mode: SendPayGasSeparately, \n    bounce: false,\n    body: "Pay bid money back to the prevNftHighestBidder".asComment()\n});\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Update Highest Bid, Bidder, and Auction Bid Period")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// Update highest bid and Transfer ton back to previous highest bidder.\nself.auctionInfo.nftHighestBidder = ctx.sender;\nself.auctionInfo.nftHighestBid = bidValue;\n// If bid value is greater than reserve price, then the auction is being started.\nif(bidValue > self.auctionInfo.reservePrice) {\n    self._update_auction_bid_period();\n    if(self.auctionEndTime == 0) { \n        // If the auction start, then set the auction end time.\n        self._update_auction_end_time();\n    }\n}\n")),(0,a.kt)("h3",{id:"settling-the-nft-auction"},"Settling the NFT Auction"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If the Auction Bid Period ends without anyone offering a higher bid, anyone can send a settlement Message to the Autction contract."),(0,a.kt)("li",{parentName:"ul"},"If the Auction has already started (the bid has already exceeded the ",(0,a.kt)("inlineCode",{parentName:"li"},"reservePrice"),"), the ",(0,a.kt)("inlineCode",{parentName:"li"},"BidValue")," will be sent to the Seller after the Auction ends, and the NFT will be transferred to the Bidder."),(0,a.kt)("li",{parentName:"ul"},"If the Auction has not started, the NFT will be returned to the Seller.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Ends the auction and transfers the NFT to the highest bidder or back to the seller(If auction not started)\nreceive("EndAuction") {\n    // If this auction started, it will transfer NFT to highest bidder.\n    // Else, it will transfer NFT to seller.\n    if(self.auctionEndTime > 0) {\n        // Pay royalty to the creator of the NFT\n        // TODO: Implement royalty payment\n        \n        // Pay winning bid amount to seller.\n        self._send_winning_bid_amount();\n        // Transfer NFT to buyer\n        let buyer: Address = self.auctionInfo.nftHighestBidder;\n        self._transfer_nft(buyer);\n        self.isInitialized = 0;\n    }\n    else {\n        // Transfer NFT to seller\n        let seller: Address = self.auctionInfo.nftSeller;\n        self._transfer_nft(seller);\n        self.isInitialized = 0;\n    }\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Transfer NFT to the new Owner"),(0,a.kt)("li",{parentName:"ul"},"Send ",(0,a.kt)("inlineCode",{parentName:"li"},"TransferNFT")," Message to NFT Auction Contract, then transfer NFT to the new Owner")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Transfer the NFT to the highest bidder\n// @note If you want change msg value, you should make sure that is enough for NFT Auction market contract to transfer NFT.\nvirtual inline fun _transfer_nft(buyer: Address) {\n    send(SendParameters{\n        to: self.owner, \n        value: ton("0.06"), \n        bounce: true,\n        mode: SendPayGasSeparately,\n        body: TransferNFT {\n            nftAddress: self.nftAddress,\n            seller: self.auctionInfo.nftSeller,\n            query_id: 0,\n            new_owner: buyer,\n            response_destination: buyer,\n            custom_payload: emptyCell(),\n            forward_amount: 0,\n            forward_payload: emptySlice()\n        }.toCell()\n    });\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Upon receiving the NFT transfer message, the NFT"),(0,a.kt)("p",{parentName:"li"},"Auction Contract sends a ",(0,a.kt)("inlineCode",{parentName:"p"},"Transfer")," message to the NFT Item to change the Owner"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Handles the TransferNFT message and facilitates NFT transfer to the auction\'s winning bidder.\nreceive(msg: TransferNFT) {\n    let ctx: Context = context();\n    let nftAuctionAddress: Address = ctx.sender;\n    self._auction_not_set_validate(nftAuctionAddress);\n    send(SendParameters{\n        to: msg.nftAddress, \n        value: 0, \n        bounce: false,\n        mode: SendRemainingValue,\n        body: Transfer {\n            query_id: msg.query_id,\n            new_owner: msg.new_owner,\n            response_destination: msg.response_destination,\n            custom_payload: msg.custom_payload,\n            forward_amount: msg.forward_amount,\n            forward_payload: msg.forward_payload\n        }.toCell()\n    });\n    self.auctionOverCheck.set(ctx.sender, null);\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(msg.seller, msg.nftAddress);\n    self.auctionTransferCheck.set(hashSellerNftAddress, null);\n}\n## <a id="auction-example-code"></a>Auction Example Code\n\n- NFT Auction Market Trait Link: <https://github.com/Ton-Dynasty/tondynasty-contracts/blob/main/contracts/packages/token/nft/NFTAuctionMarket.tact>\n- NFT Auction Trait Link: <https://github.com/Ton-Dynasty/tondynasty-contracts/blob/main/contracts/packages/token/nft/NFTAuction.tact>\n```ts\nimport "@stdlib/deploy";\nimport "./packages/token/nft/NFTAuctionMarket";\nimport "./packages/token/nft/NFTAuction";\ncontract ExampleNFTAuctionMarket with Deployable, NFTAuctionMarketStandard {\n    owner: Address;\n    // Get auction info by seller address and nft address.\n    nftContractAuctions: map<Int, AuctionInfo>; // key => hash(sellerAddress and nftAddress), value => AuctionInfo\n    // Check whether nft is transfered to NFT Auction Market Contract\n    auctionTransferCheck: map<Int, Int>; // key => hash(sellerAddress and nftAddress), value => 1: set, 0: not set\n    // Get auction info by nft collection address and nft id.\n    collectionNftIdToAuction: map<Int, Int>; // key => hash(nft collection address and nft id), value => hash(sellerAddress and nftAddress)\n    // Check whether nft auction is over or not\n    auctionOverCheck: map<Address, Address>;  // key => nft auction contract address, value => 1: not over, 0: over\n    init(owner: Address) {\n        self.owner = owner;\n    }\n\n    // @dev Retrieves the initial state for the NFT auction contract.\n    override get fun _nft_auction_init(nftAddress: Address, seller: Address): StateInit {\n        return initOf ExampleNFTAuction(myAddress(), nftAddress, seller);\n    }\n}\n\ncontract ExampleNFTAuction with NFTAuctionStandard {\n    owner: Address;\n    nftAddress: Address;\n    seller: Address;\n    auctionInfo: AuctionInfo;\n    auctionBidPeriod: Int;\n    isInitialized: Int;\n    auctionEndTime: Int;\n\n    init(owner: Address, nftAddress: Address, seller: Address) {\n        self.owner = owner;\n        self.nftAddress = nftAddress;\n        self.seller = seller;\n        self.auctionBidPeriod = 0;\n        self.auctionEndTime = 0;\n        self.isInitialized = 0;\n        self.auctionInfo = AuctionInfo {\n            bidIncreasePercentage: 0,\n            auctionBidPeriod: 0,\n            auctionPeriod: 0,\n            reservePrice: 0,\n            buyNowPrice: 0,\n            nftHighestBid: 0,\n            nftHighestBidder: newAddress(0, 0),\n            nftSeller: seller,\n            whitelistedBuyer: seller,\n            nftRecipient: seller,\n            beneficiary: seller\n        };\n    }\n}\n\n')),(0,a.kt)("h2",{id:"additional-functions"},"Additional Functions"),(0,a.kt)("h3",{id:"revise-setup-auction"},"Revise SetUp Auction"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If the auction has not yet started, the Seller can change the ",(0,a.kt)("inlineCode",{parentName:"li"},"reserve_price")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"buyNowPrice"),"."),(0,a.kt)("li",{parentName:"ul"},"Send a ",(0,a.kt)("inlineCode",{parentName:"li"},"ReviseSetUpAuction")," message to the NFT Auction Market.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// @dev Updates auction details after verifying NFT transfer and previous auction setup, then communicates the update to the nftAuctionAddress.\nreceive(msg: ReviseSetUpAuction) {\n    let ctx: Context = context();\n    let sellerAddress: Address = ctx.sender;\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(sellerAddress, msg.nftAddress);\n    self._auction_transfer_validate(hashSellerNftAddress);\n    // Get nft auction address\n    let nftAuctionAddress: Address = self.get_nft_auction_address(msg.nftAddress, sellerAddress);\n    self._auction_not_set_validate(nftAuctionAddress);\n    if(msg.beneficiary == null) {\n        msg.beneficiary = sellerAddress;\n    }\n    // Set up auction info\n    let auctionInfo: AuctionInfo = self._set_up_auction(sellerAddress, msg.nftAddress, msg.reservePrice, msg.buyNowPrice, msg.auctionPeriod, msg.beneficiary!!); // set up auction\n    self.auctionOverCheck.set(nftAuctionAddress, msg.nftAddress);\n    let newAuctionInfo: AuctionInfo = self._set_up_auction(sellerAddress, msg.nftAddress, msg.reservePrice, msg.buyNowPrice, msg.auctionPeriod, msg.beneficiary!!); // set up auction\n    send(SendParameters{\n            to: nftAuctionAddress,\n            value: 0,\n            mode: SendRemainingValue,\n            bounce: false,\n            body: ReviseAuction {\n                reviseAuctionInfo: newAuctionInfo\n            }.toCell()\n        }\n    );\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The NFT Auction Market will send a modification message to the NFT Auction Contract.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Allows owner to adjust auction\'s reserve or buy-now prices.\nreceive(msg: ReviseAuction) {\n    let ctx: Context = context();\n    require(ctx.sender == self.owner, "Only owner can revise auction contract");\n    require(self.auctionInfo.reservePrice == msg.reviseAuctionInfo.reservePrice || msg.reviseAuctionInfo.buyNowPrice == self.auctionInfo.buyNowPrice, "Cannot update reserve price and buy now price at the same time.");\n\n    // Update the reserve price of the auction.\n    // This can only be done if no bid has been made that already exceeds the original minimum price.\n    if(self.auctionEndTime == 0 && self.auctionInfo.reservePrice != msg.reviseAuctionInfo.reservePrice && msg.reviseAuctionInfo.reservePrice < self.auctionInfo.buyNowPrice) {\n\n        self.auctionInfo.reservePrice = msg.reviseAuctionInfo.reservePrice;\n        if(self.auctionInfo.nftHighestBid > self.auctionInfo.reservePrice) {\n            self._update_auction_bid_period();\n            self._update_auction_end_time();\n        }\n    }\n    // Update the buy now price of the auction.\n    // This can only be done if no bid has been made that already exceeds the original minimum price.\n    if(self.auctionEndTime == 0 && msg.reviseAuctionInfo.buyNowPrice != self.auctionInfo.buyNowPrice && msg.reviseAuctionInfo.buyNowPrice > self.auctionInfo.reservePrice) {\n        self.auctionInfo.buyNowPrice = msg.reviseAuctionInfo.buyNowPrice;\n    }\n}\n')),(0,a.kt)("h3",{id:"endauction"},"EndAuction"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If the Seller wants to terminate the auction early, they can send an ",(0,a.kt)("inlineCode",{parentName:"li"},"EndAuction")," message to the NFT Auction Market.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Allows the seller to terminate an auction. \n//      It verifies if the auction was previously set and then sends a message to the nftAuctionAddress to conclude the auction.\n//      It will transfer the NFT to the highest bidder or back to the seller(If auction not started).\nreceive(msg: EndAuction) {\n    // Seller can end auction.\n    let ctx: Context = context();\n    let sellerAddress: Address = ctx.sender;\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(sellerAddress, msg.nftAddress);\n    let nftAuctionAddress: Address = self.get_nft_auction_address(msg.nftAddress, sellerAddress);\n    self._auction_not_set_validate(nftAuctionAddress);\n    send(SendParameters{\n            to: nftAuctionAddress,\n            value: 0,\n            mode: SendRemainingValue,\n            bounce: false,\n            body: "EndAuction".asComment()\n        }\n    );\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If the auction has already started, it will immediately conclude and send the NFT to the current Highest Bidder, and the ",(0,a.kt)("inlineCode",{parentName:"li"},"BidValue")," will be sent to the Seller."),(0,a.kt)("li",{parentName:"ul"},"If the auction has not started, the NFT will be returned to the Seller.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Ends the auction and transfers the NFT to the highest bidder or back to the seller(If auction not started)\n    receive("EndAuction") {\n        // If this auction started, it will transfer NFT to highest bidder.\n        // Else, it will transfer NFT to seller.\n        if(self.auctionEndTime > 0) {\n            // Pay royalty to the creator of the NFT\n            // TODO: Implement royalty payment\n            \n            // Pay winning bid amount to seller.\n            self._send_winning_bid_amount();\n            // Transfer NFT to buyer\n            let buyer: Address = self.auctionInfo.nftHighestBidder;\n            self._transfer_nft(buyer);\n            self.isInitialized = 0;\n        }\n        else {\n            // Transfer NFT to seller\n            let seller: Address = self.auctionInfo.nftSeller;\n            self._transfer_nft(seller);\n            self.isInitialized = 0;\n        }\n    }\n')),(0,a.kt)("h3",{id:"nft-auction-market-contract-internal-functions-and-get-methods"},"NFT Auction Market Contract Internal Functions and Get Methods"),(0,a.kt)("p",null,"Internal Function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Parses payload to extract auction parameters and initializes the auction with provided data.\nvirtual inline fun _parse_forward_payload(seller: Address, nftAddress: Address, payload: Slice) {\n    // Parse payload\n    let beneficiary: Address = payload.loadAddress();\n    let reservePrice: Int = payload.loadCoins();\n    let buyNowPrice: Int = payload.loadCoins();\n    let auctionPeriod: Int = payload.loadUint(256);\n\n    // Set up auction info\n    let auctionInfo: AuctionInfo = self._set_up_auction(seller, nftAddress, reservePrice, buyNowPrice, auctionPeriod, beneficiary); // set up auction\n    self._set_price_validate(buyNowPrice, reservePrice);\n    let nftAuctionInit: StateInit = self._nft_auction_init(nftAddress, seller);\n    let nftAuctionAddress: Address = self.get_nft_auction_address(nftAddress, seller);\n    self._auction_set_validate(nftAuctionAddress);\n    self.auctionOverCheck.set(nftAuctionAddress, nftAddress);\n\n    // Deploy a new NFT Auction Contract\n    self._build_auction(nftAuctionAddress, auctionInfo,\n\n nftAuctionInit);\n}\n\n// @dev Create and configure a new NFT Auction Contract with the provided auction info.\nvirtual inline fun _build_auction(nftAuctionAddress: Address, auctionInfo: AuctionInfo, nftAuctionInit: StateInit) {\n    send(SendParameters{\n            to: nftAuctionAddress,\n            value: 0,\n            mode: SendRemainingValue,\n            bounce: false,\n            body: BuildNftAuction {\n                auctionInfo: auctionInfo\n            }.toCell(),\n            code: nftAuctionInit.code, \n            data: nftAuctionInit.data\n        }\n    );\n}\n\n// @dev Validates that the buyNowPrice is higher than the reservePrice.\nvirtual inline fun _set_price_validate(buyNowPrice: Int, reservePrice: Int) {\n    require(buyNowPrice > reservePrice, "BuyNowPrice must be greater than reservePrice.");\n}\n\n// @dev Checks if an auction has already been set for the provided NFT address.\nvirtual inline fun _auction_set_validate(nftAuctionAddress: Address) {\n    require(self.auctionOverCheck.get(nftAuctionAddress) == null, "Auction was already set for this NFT.");\n}\n\n// @dev Validates that an auction was previously set for the given NFT address.\nvirtual inline fun _auction_not_set_validate(nftAuctionAddress: Address) {\n    require(self.auctionOverCheck.get(nftAuctionAddress) != null, "Auction was not set before.");\n}\n\n// @dev Verifies that the NFT was transferred to the auction contract.\nvirtual inline fun _auction_transfer_validate(hashSellerNftAddress: Int) {\n    require(self.get_is_auction_transfer_check(hashSellerNftAddress) == 1, "This NFT didn\'t transfer to NFT Auction Market Contract yet.");\n}\n\n// @dev Initializes an auction for a specified NFT with given parameters such as reserve price, buy now price, and auction duration.\n// @note If you want to use custom auction parameters or logic, consider overriding this function and AuctionInfo struct in a derived contract.\nvirtual inline fun _set_up_auction(sellerAddress: Address, nftAddress: Address, reservePrice: Int, buyNowPrice: Int, auctionPeriod: Int, beneficiary: Address): AuctionInfo {\n    let hashSellerNftAddress: Int = self.get_hash_seller_nft_address(sellerAddress, nftAddress);\n    return AuctionInfo {\n        bidIncreasePercentage: self.defaultBidIncreasePercentage,\n        auctionBidPeriod: self.defaultAuctionBidPeriod,\n        auctionPeriod: auctionPeriod,\n        reservePrice: reservePrice,\n        buyNowPrice: buyNowPrice,\n        nftHighestBid: 0,\n        nftHighestBidder: sellerAddress,\n        nftSeller: sellerAddress,\n        whitelistedBuyer: sellerAddress,\n        nftRecipient: sellerAddress,\n        beneficiary: beneficiary\n    };\n}\n')),(0,a.kt)("p",null,"To know the parameters required for the NFT Auction's Init, you need to refer to the example of _nft_auction_init which can be found in the ",(0,a.kt)("a",{parentName:"p",href:"#auction-example-code"},"Auction Example Code"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// @dev Retrieves the initial state for the NFT auction contract.\n// @note one MUST override this function to provide NFT Auction initCode\nabstract fun _nft_auction_init(nftAddress: Address, seller: Address): StateInit;\n")),(0,a.kt)("p",null,"Get Methods:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// @dev Determines the NFT auction contract address.\nget fun get_nft_auction_address(nftAddress: Address, seller: Address): Address {\n    let nftAuctionInit: StateInit = self._nft_auction_init(nftAddress, seller);\n    return contractAddress(nftAuctionInit);\n}\n\n// @dev Generates a hash value based on the seller and NFT address.\nget fun get_hash_seller_nft_address(seller: Address, nftAddress: Address): Int {\n    return beginCell().storeAddress(seller).storeAddress(nftAddress).endCell().asSlice().hash();\n}\n\n// @dev Checks if the auction transfer for a given hash is valid.\nget fun get_is_auction_transfer_check(hashSellerNftAddress: Int): Int {\n    if(self.auctionTransferCheck.get(hashSellerNftAddress) == null) {\n        return 0;\n    }\n    else {\n        return 1;\n    }\n}\n")),(0,a.kt)("h3",{id:"nft-auction-contract-internal-functions-and-get-methods"},"NFT Auction Contract Internal Functions and Get Methods"),(0,a.kt)("p",null,"Internal Function:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'// @dev Updates the auction bid period time based on the latest bid and the defined auction bid period\nvirtual inline fun _update_auction_bid_period() {\n    self.auctionBidPeriod = now() + self.auctionInfo.auctionBidPeriod;\n}\n\n// @dev Updates the auction end time\nvirtual inline fun _update_auction_end_time() {\n    self.auctionEndTime = now() + self.auctionInfo.auctionPeriod;\n}\n\n// @dev Transfer the NFT to the highest bidder\n// @note If you want change msg value, you should make sure that is enough for NFT Auction market contract to transfer NFT.\nvirtual inline fun _transfer_nft(buyer: Address) {\n    send(SendParameters{\n        to: self.owner, \n        value: ton("0.06"), \n        bounce: true,\n        mode: SendPayGasSeparately,\n        body: TransferNFT {\n            nftAddress: self.nftAddress,\n            seller: self.auctionInfo.nftSeller,\n            query_id: 0,\n            new_owner: buyer,\n            response_destination: buyer,\n            custom_payload: emptyCell(),\n            forward_amount: 0,\n            forward_payload: emptySlice()\n        }.toCell()\n    });\n}\n\n// @dev Transfers the highest bid amount to the seller\nvirtual inline fun _send_winning_bid_amount() {\n    let seller: Address = self.auctionInfo.beneficiary;\n    let winningBidAmount: Int = self.auctionInfo.nftHighestBid;\n    send(SendParameters{\n        to: seller,\n        value: winningBidAmount - ton("0.06"), \n        mode: SendPayGasSeparately, \n        bounce: false,\n        body: "Pay winning bid amount".asComment()\n    });\n}\n\n// @dev Initializes the auction end time to 0, allowing the seller to auction the NFT again in the future\nvirtual inline fun _init_auction_end() {\n    let ctx: Context = context();\n    require(ctx.sender == self.owner, "Only owner can init auction end time.");\n    self.auctionBidPeriod = 0;\n}\n')),(0,a.kt)("p",null,"Get Methods"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// @dev Returns the current auction information\nget fun get_auction_info(): AuctionInfo {\n    return self.auctionInfo;\n}\n\n// @dev Checks if the auction is initialized and returns the state (1 for initialized, 0 otherwise)\nget fun get_is_initialized(): Int {\n    return self.isInitialized;\n}\n\n// @dev Returns the end time of the auction\nget fun get_auction_end(): Int {\n    return self.auctionEndTime;\n}\n\n// @dev Returns the auction bid period\nget fun get_auction_bid_period(): Int {\n    return self.auctionBidPeriod;\n}\n")))}f.isMDXComponent=!0},5649:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/ton_auction_flow-6192c4e2d5728a3e946c09e01eaca2fc.jpg"}}]);